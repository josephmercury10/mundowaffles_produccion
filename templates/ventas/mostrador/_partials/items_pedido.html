<div class="card-content space-y-3">
    <!-- Items actuales del pedido -->
    <div id="lista-items-actuales" class="items-list">
    {% for producto in productos %}
    <div class="order-item {% if producto.id in items_pendientes_eliminar %}item-pendiente-eliminar{% endif %}" 
         id="item-{{ producto.id }}">
        <div class="item-info">
            <div class="item-image">
                {% if producto.producto.img_path %}
                <img src="{{ url_for('static', filename='uploads/images/' + producto.producto.img_path) }}" 
                     alt="{{ producto.producto.nombre }}">
                {% else %}
                <div class="item-placeholder">üçΩÔ∏è</div>
                {% endif %}
            </div>
            <div class="item-details">
                <p class="item-name {% if producto.id in items_pendientes_eliminar %}text-decoration-line-through text-muted{% endif %}">
                    {{ producto.producto.nombre }}
                </p>
                <p class="item-price">${{ producto.precio_venta|format_price }} c/u</p>
                {% if producto.atributos_seleccionados %}
                <small class="text-success d-block" style="font-size: 0.75rem; line-height: 1.2;">
                    {% for extra in producto.atributos_seleccionados %}
                    + {{ extra.valor }}{% if extra.precio_adicional > 0 %} (${{ extra.precio_adicional|format_price }}){% endif %}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                </small>
                {% endif %}
            </div>
        </div>
        <div class="item-quantity">
            <span class="quantity-badge">x{{ producto.cantidad }}</span>
        </div>
        <div class="item-actions">
            <span class="subtotal-value">${{ (producto.cantidad * producto.precio_venta)|format_price }}</span>
            {% if pedido.estado_mostrador == 1 and not pedido.comprobante_id and producto.id not in items_pendientes_eliminar %}
            <!-- Bot√≥n marcar para eliminar -->
            <button class="btn btn-sm btn-outline-danger ms-2"
                    hx-post="/mostrador/pedido/{{ pedido.id }}/marcar_eliminar/{{ producto.id }}"
                    hx-target="#items-container"
                    hx-swap="innerHTML"
                    title="Marcar para eliminar">
                <svg class="icon-sm" viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </button>
            {% elif producto.id in items_pendientes_eliminar %}
            <!-- Bot√≥n desmarcar -->
            <button class="btn btn-sm btn-outline-secondary ms-2"
                    hx-post="/mostrador/pedido/{{ pedido.id }}/desmarcar_eliminar/{{ producto.id }}"
                    hx-target="#items-container"
                    hx-swap="innerHTML"
                    title="Cancelar eliminaci√≥n">
                ‚Ü©Ô∏è
            </button>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="empty-cart text-center py-3">
        <p class="text-muted">No hay productos en este pedido</p>
    </div>
    {% endfor %}
    </div>

    <!-- Bot√≥n confirmar eliminaci√≥n (solo si hay items marcados) -->
    {% if items_pendientes_eliminar %}
    <div class="alert alert-warning mt-3">
        <strong>‚ö†Ô∏è Productos marcados para eliminar:</strong>
        <ul class="mb-2">
            {% for item_id in items_pendientes_eliminar %}
                {% for producto in productos if producto.id == item_id %}
                <li>{{ producto.producto.nombre }} (x{{ producto.cantidad }})</li>
                {% endfor %}
            {% endfor %}
        </ul>
        <button class="btn btn-danger w-100"
                hx-post="/mostrador/pedido/{{ pedido.id }}/confirmar_eliminacion"
                hx-target="#items-container"
                hx-swap="innerHTML">
            üóëÔ∏è Confirmar Eliminaci√≥n
        </button>
    </div>
    {% endif %}

    <!-- Secci√≥n para agregar nuevos productos (solo si estado_mostrador = 1 y no est√° pagado) -->
    {% if pedido.estado_mostrador == 1 and not pedido.comprobante_id %}
    <div class="add-product-section mt-3">
        <details class="productos-acordeon" id="acordeon-agregar" ontoggle="if(this.open) htmx.trigger('#productos-disponibles-mostrador-{{ pedido.id }}', 'fetch')">
            <summary class="acordeon-header">
                <svg class="icon text-primary" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
                <span>Agregar m√°s productos</span>
                <svg class="icon-chevron" viewBox="0 0 24 24">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </summary>
            <div class="productos-grid-container">
                <!-- Lista de productos disponibles -->
                <div id="productos-disponibles-mostrador-{{ pedido.id }}"
                     hx-get="/mostrador/pedido/{{ pedido.id }}/productos_disponibles"
                     hx-trigger="fetch"
                     hx-swap="innerHTML">
                    <div class="loading-productos text-center py-3">
                        <div class="spinner"></div>
                        <span class="ms-2">Cargando productos...</span>
                    </div>
                </div>
            </div>
        </details>
    </div>

    <!-- Carrito temporal de productos nuevos -->
    {% if carrito_temporal %}
    <div class="card mt-3 border-success">
        <div class="card-header bg-success text-white">
            <strong>üõí Productos a agregar</strong>
        </div>
        <div class="card-body p-2">
            <table class="table table-sm mb-0">
                <tbody>
                {% for item in carrito_temporal %}
                <tr>
                    <td>
                        {{ item.nombre }}
                        {% if item.extras %}
                        <small class="text-success d-block" style="font-size: 0.7rem;">
                            {% for extra in item.extras %}
                            + {{ extra.valor }}{% if extra.precio_adicional > 0 %} (${{ extra.precio_adicional|format_price }}){% endif %}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </small>
                        {% endif %}
                    </td>
                    <td class="text-center" style="width:100px;">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary"
                                    hx-post="/mostrador/pedido/{{ pedido.id }}/carrito_temp/disminuir/{{ item.key }}"
                                    hx-target="#items-container"
                                    hx-swap="innerHTML">‚àí</button>
                            <span class="btn btn-light disabled">{{ item.cantidad }}</span>
                            <button class="btn btn-outline-secondary"
                                    hx-post="/mostrador/pedido/{{ pedido.id }}/carrito_temp/aumentar/{{ item.key }}"
                                    hx-target="#items-container"
                                    hx-swap="innerHTML">+</button>
                        </div>
                    </td>
                    <td class="text-end" style="width:80px;">${{ ((item.precio_total if item.precio_total else item.precio) * item.cantidad)|format_price }}</td>
                    <td style="width:40px;">
                        <button class="btn btn-sm btn-outline-danger"
                                hx-post="/mostrador/pedido/{{ pedido.id }}/carrito_temp/eliminar/{{ item.key }}"
                                hx-target="#items-container"
                                hx-swap="innerHTML">√ó</button>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="card-footer">
            <button class="btn btn-success w-100"
                    hx-post="/mostrador/pedido/{{ pedido.id }}/confirmar_productos"
                    hx-target="#items-container"
                    hx-swap="innerHTML">
                ‚úì Confirmar Productos
            </button>
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>

<!-- Total items -->
<div class="card-footer">
    <div class="summary-row summary-total">
        <span class="summary-label">Total Items:</span>
        <span class="summary-value">{{ productos|length }} producto(s)</span>
    </div>
</div>

<!-- Modal confirmaci√≥n eliminaci√≥n total -->
<div class="modal fade" id="modalConfirmarEliminarPedido" tabindex="-1" aria-labelledby="modalConfirmarEliminarPedidoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalConfirmarEliminarPedidoLabel">Confirmar eliminaci√≥n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalEliminarMensaje">
                ¬øEst√° seguro? Al eliminar todos los productos, el pedido ser√° cancelado.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger"
                                hx-post="/mostrador/pedido/{{ pedido.id }}/confirmar_eliminacion_total"
                                hx-target="#items-container"
                                hx-swap="innerHTML"
                                data-bs-dismiss="modal">
                        S√≠, eliminar pedido
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Escucha evento HTMX para mostrar modal de confirmaci√≥n total
document.body.addEventListener('mostrar-modal-eliminacion-total', function(evt) {
        const data = evt.detail && evt.detail.value ? evt.detail.value : {};
        const msg = data.mensaje || '¬øEst√° seguro? Al eliminar todos los productos, el pedido ser√° cancelado.';
        const modalBody = document.getElementById('modalEliminarMensaje');
        if (modalBody) modalBody.textContent = msg;
        const modalEl = document.getElementById('modalConfirmarEliminarPedido');
        if (modalEl) {
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
        }
});
</script>
