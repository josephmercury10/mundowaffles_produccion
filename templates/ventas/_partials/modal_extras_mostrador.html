<!-- Modal para seleccionar extras de un producto - MOSTRADOR -->
<div class="modal fade" id="extrasModalMostrador" tabindex="-1" aria-labelledby="extrasModalMostradorLabel">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="extrasModalMostradorLabel">
                    <i class="bi bi-plus-circle"></i> Seleccionar Extras
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <h6 id="extras-producto-nombre-mostrador" class="mb-3"></h6>
                <input type="hidden" id="extras-producto-id-mostrador">
                <input type="hidden" id="extras-producto-precio-mostrador">
                <input type="hidden" id="extras-producto-nombre-hidden-mostrador">
                
                <div id="extras-container-mostrador">
                    <!-- Aquí se cargan dinámicamente los extras -->
                    <div class="text-center py-3">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen de precio -->
                <div class="mt-3 p-2 bg-light rounded">
                    <div class="d-flex justify-content-between">
                        <span>Precio base:</span>
                        <span id="extras-precio-base-mostrador">$0</span>
                    </div>
                    <div class="d-flex justify-content-between text-success">
                        <span>Extras:</span>
                        <span id="extras-precio-adicional-mostrador">+$0</span>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total:</span>
                        <span id="extras-precio-total-mostrador">$0</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btn-confirmar-extras-mostrador" tabindex="-1">
                    <i class="bi bi-cart-plus"></i> Agregar al Carrito
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales para el modal de extras de mostrador
let extrasSeleccionadosMostrador = [];
let precioBaseActualMostrador = 0;
let modoDetallePedidoMostrador = false;  // true si estamos editando un pedido existente
let pedidoIdActualMostrador = null;

// Función para formatear precio
function formatPriceMostrador(value) {
    return '$' + Math.round(value).toLocaleString('es-CL');
}

// Función para abrir el modal de extras
function abrirModalExtrasMostrador(productoId, nombre, precio, esDetalle = false, pedidoId = null) {
    precioBaseActualMostrador = parseFloat(precio);
    extrasSeleccionadosMostrador = [];
    modoDetallePedidoMostrador = esDetalle;
    pedidoIdActualMostrador = pedidoId;
    
    // Actualizar campos ocultos
    document.getElementById('extras-producto-id-mostrador').value = productoId;
    document.getElementById('extras-producto-precio-mostrador').value = precio;
    document.getElementById('extras-producto-nombre-hidden-mostrador').value = nombre;
    document.getElementById('extras-producto-nombre-mostrador').textContent = nombre;
    document.getElementById('extras-precio-base-mostrador').textContent = formatPriceMostrador(precio);
    
    // Resetear precios visualmente
    document.getElementById('extras-precio-adicional-mostrador').textContent = '+' + formatPriceMostrador(0);
    document.getElementById('extras-precio-total-mostrador').textContent = formatPriceMostrador(precio);
    
    // Mostrar loading
    document.getElementById('extras-container-mostrador').innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    `;
    
    // Cargar extras desde API
    fetch(`/mostrador/get_atributos_producto/${productoId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.atributos) {
                renderizarExtrasMostrador(data.atributos);
            } else {
                document.getElementById('extras-container-mostrador').innerHTML = `
                    <p class="text-muted">Este producto no tiene extras disponibles.</p>
                `;
            }
        })
        .catch(error => {
            console.error('Error cargando extras:', error);
            document.getElementById('extras-container-mostrador').innerHTML = `
                <div class="alert alert-danger">Error al cargar extras</div>
            `;
        });
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('extrasModalMostrador'));
    modal.show();
}

// Renderizar los extras en el modal
function renderizarExtrasMostrador(atributos) {
    const container = document.getElementById('extras-container-mostrador');
    
    if (!atributos || atributos.length === 0) {
        container.innerHTML = '<p class="text-muted">Este producto no tiene extras disponibles.</p>';
        return;
    }
    
    let html = '';
    
    atributos.forEach(atributo => {
        html += `
            <div class="mb-3">
                <label class="form-label fw-bold">
                    ${atributo.nombre}
                    ${atributo.es_obligatorio ? '<span class="text-danger">*</span>' : ''}
                </label>
                ${atributo.descripcion ? `<small class="text-muted d-block mb-2">${atributo.descripcion}</small>` : ''}
                <div class="extras-valores">
        `;
        
        atributo.valores.forEach(valor => {
            const inputType = atributo.es_multiple ? 'checkbox' : 'radio';
            const inputName = `extra_mostrador_${atributo.id}`;
            const precioAdicional = parseFloat(valor.precio_adicional) || 0;
            const precioTexto = precioAdicional > 0 ? `+${formatPriceMostrador(precioAdicional)}` : 'Sin cargo';
            
            html += `
                <div class="form-check">
                    <input class="form-check-input extra-checkbox-mostrador" 
                           type="${inputType}" 
                           name="${inputName}" 
                           id="valor_mostrador_${valor.id}"
                           value="${valor.id}"
                           data-atributo-id="${atributo.id}"
                           data-atributo-nombre="${atributo.nombre}"
                           data-valor="${valor.valor}"
                           data-precio="${precioAdicional}"
                           onchange="actualizarPrecioExtrasMostrador()">
                    <label class="form-check-label" for="valor_mostrador_${valor.id}">
                        ${valor.valor}
                        <span class="badge ${precioAdicional > 0 ? 'bg-success' : 'bg-secondary'}">${precioTexto}</span>
                    </label>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Actualizar precios después de renderizar (todos los checkboxes están deseleccionados)
    actualizarPrecioExtrasMostrador();
}

// Actualizar el precio total con extras
function actualizarPrecioExtrasMostrador() {
    const checkboxes = document.querySelectorAll('.extra-checkbox-mostrador:checked');
    let totalExtras = 0;
    extrasSeleccionadosMostrador = [];
    
    checkboxes.forEach(cb => {
        const precio = parseFloat(cb.dataset.precio) || 0;
        totalExtras += precio;
        
        // Formato de extras compatible con el backend
        extrasSeleccionadosMostrador.push({
            id: parseInt(cb.value),
            valor: cb.dataset.valor,
            precio_adicional: precio
        });
    });
    
    document.getElementById('extras-precio-adicional-mostrador').textContent = '+' + formatPriceMostrador(totalExtras);
    document.getElementById('extras-precio-total-mostrador').textContent = formatPriceMostrador(precioBaseActualMostrador + totalExtras);
}

// Confirmar y agregar al carrito con extras
document.getElementById('btn-confirmar-extras-mostrador').addEventListener('click', function() {
    const productoId = document.getElementById('extras-producto-id-mostrador').value;
    const nombre = document.getElementById('extras-producto-nombre-hidden-mostrador').value;
    const precioBase = parseFloat(document.getElementById('extras-producto-precio-mostrador').value);
    
    // Calcular precio total
    let precioExtras = 0;
    extrasSeleccionadosMostrador.forEach(e => precioExtras += e.precio_adicional);
    const precioTotal = precioBase + precioExtras;
    
    // Preparar datos para enviar
    const formData = new FormData();
    formData.append('producto_id', productoId);
    formData.append('nombre', nombre);
    formData.append('precio', precioTotal);  // Precio total (base + extras)
    formData.append('precio_base', precioBase);
    formData.append('extras', JSON.stringify(extrasSeleccionadosMostrador));
    
    // Determinar la URL según el modo
    let url;
    if (modoDetallePedidoMostrador && pedidoIdActualMostrador) {
        // Agregar al carrito temporal del pedido existente
        url = `/mostrador/pedido/${pedidoIdActualMostrador}/carrito_temp/agregar`;
    } else {
        // Agregar al carrito de nuevo pedido
        url = '/mostrador/agregar_producto';
    }
    
    // Enviar al servidor
    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        if (modoDetallePedidoMostrador && pedidoIdActualMostrador) {
            // Actualizar el contenedor de items del pedido
            const itemsContainer = document.getElementById('items-container');
            if (itemsContainer) {
                itemsContainer.innerHTML = html;
                // Procesar HTMX en el nuevo contenido
                if (typeof htmx !== 'undefined') {
                    htmx.process(itemsContainer);
                }
            }
        } else {
            // Actualizar el contenedor del carrito
            const carritoContainer = document.getElementById('carrito-container');
            if (carritoContainer) {
                carritoContainer.innerHTML = html;
                // Procesar HTMX en el nuevo contenido
                if (typeof htmx !== 'undefined') {
                    htmx.process(carritoContainer);
                }
            }
        }
        
        // Quitar foco del botón antes de cerrar para evitar error de aria-hidden
        document.activeElement.blur();
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('extrasModalMostrador'));
        modal.hide();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al agregar al carrito');
    });
});
</script>
