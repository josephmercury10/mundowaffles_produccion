<!-- Modal para seleccionar extras de un producto -->
<div class="modal fade" id="extrasModal" tabindex="-1" aria-labelledby="extrasModalLabel">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="extrasModalLabel">
                    <i class="bi bi-plus-circle"></i> Seleccionar Extras
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <h6 id="extras-producto-nombre" class="mb-3"></h6>
                <input type="hidden" id="extras-producto-id">
                <input type="hidden" id="extras-producto-precio">
                <input type="hidden" id="extras-producto-nombre-hidden">
                
                <div id="extras-container">
                    <!-- Aquí se cargan dinámicamente los extras -->
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen de precio -->
                <div class="mt-3 p-2 bg-light rounded">
                    <div class="d-flex justify-content-between">
                        <span>Precio base:</span>
                        <span id="extras-precio-base">$0</span>
                    </div>
                    <div class="d-flex justify-content-between text-success">
                        <span>Extras:</span>
                        <span id="extras-precio-adicional">+$0</span>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total:</span>
                        <span id="extras-precio-total">$0</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-confirmar-extras" tabindex="-1">
                    <i class="bi bi-cart-plus"></i> Agregar al Carrito
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales para el modal de extras
let extrasSeleccionados = [];
let precioBaseActual = 0;

// Función para formatear precio
function formatPriceModal(value) {
    return '$' + Math.round(value).toLocaleString('es-CL');
}

// Función para abrir el modal de extras
function abrirModalExtras(productoId, nombre, precio) {
    precioBaseActual = parseFloat(precio);
    extrasSeleccionados = [];
    
    // Actualizar campos ocultos
    document.getElementById('extras-producto-id').value = productoId;
    document.getElementById('extras-producto-precio').value = precio;
    document.getElementById('extras-producto-nombre-hidden').value = nombre;
    document.getElementById('extras-producto-nombre').textContent = nombre;
    document.getElementById('extras-precio-base').textContent = formatPriceModal(precio);
    
    // Resetear precios visualmente
    document.getElementById('extras-precio-adicional').textContent = '+' + formatPriceModal(0);
    document.getElementById('extras-precio-total').textContent = formatPriceModal(precio);
    
    // Mostrar loading
    document.getElementById('extras-container').innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    `;
    
    // Cargar extras desde API
    fetch(`/delivery/get_atributos_producto/${productoId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.atributos) {
                renderizarExtras(data.atributos);
            } else {
                document.getElementById('extras-container').innerHTML = `
                    <p class="text-muted">Este producto no tiene extras disponibles.</p>
                `;
            }
        })
        .catch(error => {
            console.error('Error cargando extras:', error);
            document.getElementById('extras-container').innerHTML = `
                <div class="alert alert-danger">Error al cargar extras</div>
            `;
        });
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('extrasModal'));
    modal.show();
}

// Renderizar los extras en el modal
function renderizarExtras(atributos) {
    const container = document.getElementById('extras-container');
    
    if (!atributos || atributos.length === 0) {
        container.innerHTML = '<p class="text-muted">Este producto no tiene extras disponibles.</p>';
        return;
    }
    
    let html = '';
    
    atributos.forEach(atributo => {
        html += `
            <div class="mb-3">
                <label class="form-label fw-bold">
                    ${atributo.nombre}
                    ${atributo.es_obligatorio ? '<span class="text-danger">*</span>' : ''}
                </label>
                ${atributo.descripcion ? `<small class="text-muted d-block mb-2">${atributo.descripcion}</small>` : ''}
                <div class="extras-valores">
        `;
        
        atributo.valores.forEach(valor => {
            const inputType = atributo.es_multiple ? 'checkbox' : 'radio';
            const inputName = `extra_${atributo.id}`;
            const precioAdicional = parseFloat(valor.precio_adicional) || 0;
            const precioTexto = precioAdicional > 0 ? `+${formatPriceModal(precioAdicional)}` : 'Sin cargo';
            
            html += `
                <div class="form-check">
                    <input class="form-check-input extra-checkbox" 
                           type="${inputType}" 
                           name="${inputName}" 
                           id="valor_${valor.id}"
                           value="${valor.id}"
                           data-atributo-id="${atributo.id}"
                           data-atributo-nombre="${atributo.nombre}"
                           data-valor="${valor.valor}"
                           data-precio="${precioAdicional}"
                           onchange="actualizarPrecioExtras()">
                    <label class="form-check-label" for="valor_${valor.id}">
                        ${valor.valor}
                        <span class="badge ${precioAdicional > 0 ? 'bg-success' : 'bg-secondary'}">${precioTexto}</span>
                    </label>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Actualizar precios después de renderizar (todos los checkboxes están deseleccionados)
    actualizarPrecioExtras();
}

// Actualizar el precio total con extras
function actualizarPrecioExtras() {
    const checkboxes = document.querySelectorAll('.extra-checkbox:checked');
    let totalExtras = 0;
    extrasSeleccionados = [];
    
    checkboxes.forEach(cb => {
        const precio = parseFloat(cb.dataset.precio) || 0;
        totalExtras += precio;
        
        // Formato de extras compatible con el backend
        extrasSeleccionados.push({
            id: parseInt(cb.value),
            valor: cb.dataset.valor,
            precio_adicional: precio
        });
    });
    
    document.getElementById('extras-precio-adicional').textContent = '+' + formatPriceModal(totalExtras);
    document.getElementById('extras-precio-total').textContent = formatPriceModal(precioBaseActual + totalExtras);
}

// Confirmar y agregar al carrito con extras
document.getElementById('btn-confirmar-extras').addEventListener('click', function() {
    const productoId = document.getElementById('extras-producto-id').value;
    const nombre = document.getElementById('extras-producto-nombre-hidden').value;
    const precioBase = parseFloat(document.getElementById('extras-producto-precio').value);
    
    // Calcular precio total
    let precioExtras = 0;
    extrasSeleccionados.forEach(e => precioExtras += e.precio_adicional);
    const precioTotal = precioBase + precioExtras;
    
    // Preparar datos para enviar
    const formData = new FormData();
    formData.append('producto_id', productoId);
    formData.append('nombre', nombre);
    formData.append('precio', precioTotal);
    formData.append('precio_base', precioBase);
    formData.append('extras', JSON.stringify(extrasSeleccionados));
    
    // Enviar al servidor (ruta de delivery)
    fetch('/delivery/agregar_al_carrito', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        // Actualizar el contenedor del carrito
        const carritoContainer = document.getElementById('carrito-container');
        if (carritoContainer) {
            carritoContainer.innerHTML = html;
            // Procesar HTMX en el nuevo contenido
            htmx.process(carritoContainer);
        }
        
        // Quitar foco del botón antes de cerrar para evitar error de aria-hidden
        document.activeElement.blur();
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('extrasModal'));
        modal.hide();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al agregar al carrito');
    });
});
</script>
