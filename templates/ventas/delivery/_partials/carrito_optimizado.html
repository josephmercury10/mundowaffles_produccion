<!-- ventas/delivery/_partials/carrito_optimizado.html -->
<div class="new-order-panel">
    <div class="new-order-header">AGREGAR PRODUCTOS</div>
</div>

<div class="container w-100 mt-3">
    <div class="row">
        <!-- Panel superior: Productos -->
        <div class="col-12 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Productos Disponibles</h5>
                    <input type="text" 
                           id="buscar-producto" 
                           class="form-control form-control-sm mt-2" 
                           placeholder="üîç Buscar producto...">
                </div>
                <div class="card-body" style="max-height: 380px; overflow-y: auto;">
                    <div class="row g-2" id="productos-grid">
                        {% for producto in productos %}
                        <div class="col-4 col-md-3 producto-item" data-nombre="{{ producto.nombre|lower }}">
                            <div class="card product-card h-100" style="cursor: pointer;"
                                 onclick="agregarProducto({{ producto.id }}, '{{ producto.nombre|replace("'", "\\'") }}', {{ producto.precio }})">
                                {% if producto.img_path %}
                                <img src="{{ url_for('static', filename='uploads/images/' + producto.img_path) }}" 
                                     class="card-img-top" alt="{{ producto.nombre }}"
                                     style="object-fit: cover; height: 50px;">
                                {% else %}
                                <div class="card-img-top bg-light d-flex align-items-center justify-content-center" 
                                     style="height: 50px;">
                                    <span class="text-muted" style="font-size:1.2rem;">üçΩÔ∏è</span>
                                </div>
                                {% endif %}
                                <div class="card-body p-1 text-center">
                                    <small class="card-title d-block mb-0 text-truncate" style="font-size:0.7rem;">{{ producto.nombre }}</small>
                                    <span class="text-primary fw-bold" style="font-size:0.75rem;">${{ producto.precio|format_price }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Panel inferior: Carrito -->
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üõí Carrito</h5>
                    <small>Cliente: {{ cliente.nombre }} | üìû {{ cliente.telefono }}</small>
                </div>
                <div id="carrito-container">
                    {% include 'ventas/delivery/_partials/carrito_items.html' %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Datos ocultos para el pedido -->
<form id="datos-pedido" style="display: none;">
    <input type="hidden" name="cliente_id" value="{{ cliente.id }}">
    <input type="hidden" name="costo_envio" value="{{ cliente.costo_envio }}">
    <input type="hidden" name="tiempo_estimado" value="{{ cliente.tiempo_estimado }}">
    <input type="hidden" name="comentarios" value="{{ cliente.comentarios }}">
    <input type="hidden" name="repartidor" value="{{ cliente.repartidor }}">
</form>

<script>
// Filtro de b√∫squeda de productos
document.getElementById('buscar-producto')?.addEventListener('input', function() {
    const filtro = this.value.toLowerCase();
    document.querySelectorAll('.producto-item').forEach(item => {
        const nombre = item.dataset.nombre;
        item.style.display = nombre.includes(filtro) ? '' : 'none';
    });
});

// Funci√≥n para agregar producto (verifica si tiene extras primero)
async function agregarProducto(productoId, nombre, precio) {
    try {
        // Verificar si el producto tiene atributos
        const response = await fetch(`/delivery/tiene_atributos/${productoId}`);
        const data = await response.json();
        
        if (data.tiene_atributos) {
            // Abrir modal de extras
            abrirModalExtras(productoId, nombre, precio);
        } else {
            // Agregar directamente al carrito sin extras
            agregarAlCarritoDirecto(productoId, nombre, precio);
        }
    } catch (error) {
        console.error('Error verificando atributos:', error);
        // En caso de error, agregar directamente
        agregarAlCarritoDirecto(productoId, nombre, precio);
    }
}

// Agregar al carrito sin extras
function agregarAlCarritoDirecto(productoId, nombre, precio) {
    const formData = new FormData();
    formData.append('producto_id', productoId);
    formData.append('nombre', nombre);
    formData.append('precio', precio);
    formData.append('extras', '[]');
    
    fetch('/delivery/agregar_al_carrito', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        const container = document.getElementById('carrito-container');
        container.innerHTML = html;
        // Procesar HTMX en el nuevo contenido
        htmx.process(container);
    })
    .catch(error => console.error('Error:', error));
}
</script>